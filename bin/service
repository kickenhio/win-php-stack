#!/bin/bash
SERVICE="$1"
COMMAND="$2"
PHPEXEC=$(php.exe -i | grep php.exe | head --lines 1)
PHPEXEC=${PHPEXEC#*>}
PHPDIR=${PHPEXEC%\/php.exe*}
PHPDIR=$(echo $PHPDIR | tr -d '\r')
NGINXPATH="$(dirname "$0")"
NGINXPATH=${NGINXPATH%\/bin*}


function processing() {
    COUNT=$(tasklist | findstr "$1" | wc -l)
    echo $COUNT
}

function terminate() {
    PSP=$(processing cgi)
    MESSAGE="No cgi processes to kill"
    if [ $PSP != "0" ]; then
        MESSAGE=$(taskkill //IM "$1" //F)
    fi
    echo $MESSAGE
}

if [ $SERVICE ] && [ $SERVICE == 'nginx' ]; then
    if [ $COMMAND ] && [ $COMMAND == 'start' ]; then
        cd "$NGINXPATH"
        PS=$(processing nginx)
        if [ $PS == "0" ]; then
            start nginx
            echo 'Nginx is warming up...'
            PSP=$(processing cgi)
            if [ $PSP == "0" ]; then
                cd "$PHPDIR"
                start //B "" php-cgi.exe -b 127.0.0.1:9000
                start //B "" php-cgi.exe -b 127.0.0.1:9001
                start //B "" php-cgi.exe -b 127.0.0.1:9002
                start //B "" php-cgi.exe -b 127.0.0.1:9003
                start //B "" php-cgi.exe -b 127.0.0.1:9004
                start //B "" php-cgi.exe -b 127.0.0.1:9005
                start //B "" php-cgi.exe -b 127.0.0.1:9006
                start //B "" php-cgi.exe -b 127.0.0.1:9007
                start //B "" php-cgi.exe -b 127.0.0.1:9008
                start //B "" php-cgi.exe -b 127.0.0.1:9009
                echo 'Booting up 10 PHP-CGI processes'
            fi
        else
            echo 'Nginx is already running'
        fi
    elif [ $COMMAND ]; then
        cd "$NGINXPATH"
        PS=$(processing nginx)
        if [ $PS == "0" ]; then
            echo "Nginx service is not running!"
        else
            ./nginx.exe -s $COMMAND
            echo "Processing $COMMAND for nginx service..."
        fi
        echo $(terminate "php-cgi.exe")
        if [ $COMMAND != 'stop' ]; then
            cd "$PHPDIR"
            start //B "" php-cgi.exe -b 127.0.0.1:9000
            start //B "" php-cgi.exe -b 127.0.0.1:9001
            start //B "" php-cgi.exe -b 127.0.0.1:9002
            start //B "" php-cgi.exe -b 127.0.0.1:9003
            start //B "" php-cgi.exe -b 127.0.0.1:9004
            start //B "" php-cgi.exe -b 127.0.0.1:9005
            start //B "" php-cgi.exe -b 127.0.0.1:9006
            start //B "" php-cgi.exe -b 127.0.0.1:9007
            start //B "" php-cgi.exe -b 127.0.0.1:9008
            start //B "" php-cgi.exe -b 127.0.0.1:9009
            echo 'Booting up 10 PHP-CGI processes'
        fi
    else
        echo 'No command provided'
    fi
else
    echo 'No such a service'
fi