#!/bin/bash
SERVICE="$1"
COMMAND="$2"
NGINXPATH="$(dirname "$0")"
NGINXPATH=${NGINXPATH%\/bin*}
PHPVERSION="7.4.2"

function processing() {
    COUNT=$(tasklist | findstr "$1" | wc -l)
    echo $COUNT
}

# function terminate() {
#     # service nginx stop
#     # service redis stop
#     # service fpm stop
# }

if [ ! -f "$NGINXPATH/conf/upstreams.conf" ]; then
    echo -e "nie ma pliku"
    # service init
fi

if [ ! -f "$NGINXPATH/conf/nginx.conf" ]; then
    echo -e "\e[1;32mINITIALIZING NGINX.CONF FILE\e[0m"
    WINPATH=$(cygpath -w "$NGINXPATH")
    TEST=$(echo "${WINPATH}" | sed 's;\\;\\/;g')
    COMMAND='s/'"\$ROOTDIR"'/'"${TEST}"'/g'
    sed "$COMMAND" "${NGINXPATH}/services/nginx/nginx.conf" > "${NGINXPATH}/conf/nginx.conf"
    echo -e "\e[1;31mDONE\e[0m"
fi

if [ $SERVICE ] && [ $SERVICE == 'init' ]; then
    echo -e "SERVICE IS NOT PROPERLY INITIALIZED. STARTING..."

    echo -e "GENERATING CONF FILE..."
    echo -e "DOING RESERVATION FOR PORT RANGE"
    # cp "service/nginx.conf.template" "service/nginx.conf"
    echo -e ""

    # TODO
    # skopiowac plik service/nginx.conf.template ze zmiana ROOTDIR na aktualny katalogu z zmiennej $NGINXPATH
    # wygenerowac plik upstreamconf z listy portow na podstawie wolnych portow z zakresu 9001-9099
    # notice: zabezpieczyc sytuacje, gdy start nginxa odpala inne porty niz cgi
fi

if [ $SERVICE ] && [ $SERVICE == 'nginx' ]; then
    if [ $COMMAND ]; then
        cd "$NGINXPATH"
        PS=$(processing nginx)
        
        if [ $COMMAND == 'start' ]; then
            if [ $PS == "0" ]; then
                start nginx
                echo 'Nginx is warming up...'
            else
                echo 'Nginx is already running'
            fi
        elif [ $COMMAND == 'stop' ]; then
            if [ $PS == "0" ]; then
                echo 'Cannot stop not running nginx service =)'
            else
                ./nginx.exe -s $COMMAND
                echo 'Nginx stopped'
            fi
        elif [ $COMMAND == 'restart' ]; then
            service nginx reload
        elif [ $COMMAND == 'reload' ]; then
            if [ $PS == "0" ]; then
                echo 'Nginx is not running'
            else
                ./nginx.exe -s $COMMAND
                echo 'Nginx is reloading configuration'
            fi
        fi
    else
        echo 'Missing command'
    fi
fi

if [ $SERVICE ] && [ $SERVICE == 'redis' ]; then
    BDS=$(processing biedis)
    if [ $COMMAND == 'start' ]; then
        if [ $BDS == "0" ]; then
            start //B "" biedis
            echo 'Biedis is warming up...'
        else
            echo 'Biedis is already running'
        fi
    elif [ $COMMAND == 'restart' ]; then
        service redis stop
        service redis start
    elif [ $COMMAND == 'stop' ]; then
        if [ $BDS == "0" ]; then
            echo 'Cannot stop not running nginx service =)'
        else
            taskkill //IM "biedis.exe" //F
            echo 'Nginx stopped'
        fi
    fi
fi

if [ $SERVICE ] && [ $SERVICE == 'fpm' ]; then
    BDS=$(processing fpm)
    
    if [ $COMMAND == 'start' ]; then
        if [ $BDS == "0" ]; then
            # parsuj upstreams.conf po wersje php
            # parsuj conf/upstreams.conf po porty dla stream
            PHPPATH="$NGINXPATH/php/php-$PHPVERSION"
            start //B "" fpm "$PHPPATH" 9001 9002 9004 9005 9006 9007 9008 9008 9009 9012 9013
            echo 'FPM is warming up...'
        else
            echo 'FPM is already running'
        fi
    elif [ $COMMAND == 'restart' ]; then
        service fpm stop
        service fpm start
    elif [ $COMMAND == 'stop' ]; then
        if [ $BDS == "0" ]; then
            echo 'Cannot stop not running fpm service =)'
        else
            taskkill //IM "fpm.exe" //F
            echo 'FPM stopped'
        fi

        CGI=$(processing php-cgi)
        if [ $CGI == "0" ]; then
            echo 'WORKER CGI PROCESSES ARE STOPPED'
        else
            taskkill //IM "php-cgi.exe" //F
            echo 'FPM stopped'
        fi
    fi
fi